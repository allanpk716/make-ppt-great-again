# 本地开发使用指南

## 项目简介

这是一个 AI 原生 PPT 协作助手项目，用户可以通过自然语言与 AI 对话来生成和修改 PowerPoint 演示文稿。项目采用前后端分离架构，集成了 Claude Code CLI 进行智能内容生成。

### 技术栈

**前端**
- React 18.3.1 + TypeScript
- Vite 6.0.5 (构建工具)
- Fabric.js 5.3.0 (Canvas 渲染)
- Zustand 5.0.2 (状态管理)
- Tailwind CSS (样式框架)

**后端**
- Express 4.21.2 (Web 框架)
- WebSocket (实时通信)
- TypeScript 5.6.2

## 环境要求

### 必需软件

1. **Node.js**: 推荐 v18.0.0 或更高版本
   - 下载地址: https://nodejs.org/

2. **npm**: 随 Node.js 一起安装
   - 验证: `npm --version`

3. **Claude Code CLI**: AI 核心功能依赖
   - 安装: 参考 [Claude Code 官方文档](https://claude.ai/code)
   - 验证: `claude --version`

### 可选软件

- Git: 版本控制 (推荐安装)
- IDE: VSCode、WebStorm 等

## 安装步骤

### 1. 克隆项目 (如适用)

```bash
git clone git@github.com:allanpk716/make-ppt-great-again.git
cd make-ppt-great-again
```

### 2. 安装依赖

在项目根目录执行：

```bash
npm install
```

这将自动安装以下工作区的依赖：
- `frontend/` - 前端依赖
- `backend/` - 后端依赖
- 根目录 - 开发工具 (concurrently)

### 3. 验证安装

```bash
# 检查 Node.js 版本
node --version

# 检查依赖安装
ls node_modules

# 检查前端依赖
ls frontend/node_modules

# 检查后端依赖
ls backend/node_modules
```

## 开发模式启动

### 方式一: 同时启动前后端 (推荐)

在项目根目录执行：

```bash
npm run dev
```

这将使用 `concurrently` 同时启动:
- 前端开发服务器: http://localhost:5173
- 后端 API 服务器: http://localhost:3001

### 方式二: 分别启动前后端

**终端 1 - 启动后端:**

```bash
npm run dev:backend
```

后端服务运行在 http://localhost:3001

**终端 2 - 启动前端:**

```bash
npm run dev:frontend
```

前端服务运行在 http://localhost:5173

### 验证服务状态

1. 访问前端: http://localhost:5173
2. 检查浏览器控制台是否有错误
3. 检查后端终端输出: `Server running on port 3001`

## 项目结构

```
make-ppt-great-again/
├── frontend/              # 前端应用
│   ├── src/
│   │   ├── components/    # React 组件
│   │   │   ├── CopilotPanel/   # AI 对话面板
│   │   │   ├── SlideSidebar/   # 幻灯片侧边栏
│   │   │   ├── Toast/          # 通知组件
│   │   │   └── Workspace/      # 画布工作区
│   │   ├── lib/          # 工具库
│   │   │   ├── fabricConverter.ts    # Fabric.js 转换器
│   │   │   ├── streamJsonParser.ts  # Stream-JSON 解析器
│   │   │   ├── thumbnailGenerator.ts # 缩略图生成器
│   │   │   └── websocketClient.ts    # WebSocket 客户端
│   │   ├── stores/       # Zustand 状态管理
│   │   ├── types/        # TypeScript 类型定义
│   │   ├── App.tsx       # 主应用组件
│   │   └── main.tsx      # 入口文件
│   ├── public/           # 静态资源
│   ├── package.json
│   └── vite.config.ts    # Vite 配置
│
├── backend/              # 后端应用
│   ├── src/
│   │   ├── middleware/   # 中间件
│   │   │   └── wsHandler.ts       # WebSocket 处理器
│   │   ├── routes/       # API 路由
│   │   │   ├── project.ts         # 项目 API
│   │   │   └── slides.ts          # 幻灯片 API
│   │   ├── services/     # 服务层
│   │   │   ├── sessionManager.ts  # 会话管理
│   │   │   └── versionManager.ts  # 版本管理
│   │   └── index.ts      # 入口文件
│   ├── projects/         # 项目数据目录 (自动创建)
│   └── package.json
│
├── docs/                 # 文档目录
│   └── plans/           # 开发计划
├── package.json         # 根 package.json (工作区配置)
└── CLAUDE.md           # Claude Code 协作规则
```

## API 使用说明

### 后端 API 基础地址

```
http://localhost:3001
```

### RESTful API 端点

#### 1. 项目管理

**验证项目版本**
```
GET /api/project/:projectId/validate
```

**迁移项目数据**
```
POST /api/project/:projectId/migrate
```

#### 2. 幻灯片管理

**获取幻灯片数据**
```
GET /api/:projectId/slides/:slideId
```

**更新幻灯片数据**
```
PUT /api/:projectId/slides/:slideId
Content-Type: application/json

{
  "version": "1.0",
  "pageSize": { "width": 1280, "height": 720 },
  "background": "#ffffff",
  "elements": [...]
}
```

**创建新幻灯片**
```
POST /api/:projectId/slides
Content-Type: application/json

{
  "slideId": "optional-slide-id",
  "displayIndex": 0
}
```

### WebSocket 连接

**连接地址**
```
ws://localhost:3001?projectId=<projectId>&slideId=<slideId>
```

**消息格式**

发送消息到 AI:
```json
{
  "type": "message",
  "text": "创建一个标题幻灯片"
}
```

接收 Stream-JSON 事件:
```json
{
  "type": "stream",
  "slideId": "xxx",
  "data": {
    "type": "thinking" | "tool_use" | "tool_result" | "text" | "error",
    ...
  }
}
```

会话结束:
```json
{
  "type": "done",
  "slideId": "xxx"
}
```

错误消息:
```json
{
  "type": "error",
  "slideId": "xxx",
  "error": "错误信息"
}
```

## 开发注意事项

### 前端开发

1. **热更新**: Vite 提供快速热更新，修改代码后浏览器自动刷新

2. **状态持久化**:
   - 状态自动保存到 `localStorage`
   - 刷新页面后自动恢复

3. **Canvas 操作**:
   - 所有画布操作通过 `FabricConverter` 转换
   - 节流保存: 500ms 防止频繁更新

4. **缩略图生成**:
   - 自动缓存 (最多 50 个)
   - 懒加载策略

### 后端开发

1. **TypeScript 编译**:
   - 开发模式使用 `tsx watch` 实时编译
   - 修改代码后自动重启

2. **会话管理**:
   - 每个 slideId 对应一个独立的 CLI 会话
   - 最大并发: 5 个会话
   - 超时清理: 30 分钟无活动自动关闭

3. **项目数据**:
   - 自动创建 `projects/` 目录
   - 数据结构: `projects/<projectId>/slides/<slideId>/`

### 调试技巧

**前端调试**
```javascript
// 在浏览器控制台访问 Zustand store
const store = window.__PPT_STORE__;
console.log(store.getState());

// 查看当前状态
console.log(store.getState().slides);
console.log(store.getState().currentSlideId);
```

**后端调试**
```bash
# 查看 CLI 会话日志
# 后端终端会输出每个会话的 stdout/stderr
```

**WebSocket 调试**
```javascript
// 在浏览器控制台测试 WebSocket
const ws = new WebSocket('ws://localhost:3001?projectId=test&slideId=slide1');
ws.onmessage = (e) => console.log(JSON.parse(e.data));
ws.send(JSON.stringify({ type: 'message', text: '测试消息' }));
```

## 生产构建

### 构建前端

```bash
npm run build:frontend
```

输出目录: `frontend/dist/`

### 构建后端

```bash
npm run build:backend
```

输出目录: `backend/dist/`

### 同时构建

```bash
npm run build
```

## 常见问题

### 1. 端口冲突

**问题**: `Error: listen EADDRINUSE: address already in use`

**解决**:
```bash
# Windows
netstat -ano | findstr :3001
taskkill /PID <PID> /F

# 或修改端口
set PORT=3002
npm run dev:backend
```

### 2. 依赖安装失败

**问题**: `npm install` 报错

**解决**:
```bash
# 清除缓存
npm cache clean --force

# 删除 node_modules 重新安装
rm -rf node_modules
rm -rf frontend/node_modules
rm -rf backend/node_modules
npm install
```

### 3. TypeScript 编译错误

**问题**: 类型错误或找不到模块

**解决**:
```bash
# 重新安装类型定义
cd frontend
npm install --save-dev @types/fabric @types/react @types/react-dom

cd ../backend
npm install --save-dev @types/node @types/express @types/ws
```

### 4. WebSocket 连接失败

**问题**: 前端无法连接 WebSocket

**检查**:
1. 后端是否正常运行
2. 防火墙是否阻止
3. 浏览器控制台错误信息

### 5. Claude Code CLI 未找到

**问题**: `Error: spawn claude ENOENT`

**解决**:
```bash
# 检查 Claude Code CLI 是否安装
claude --version

# 如未安装，参考官方文档安装
# https://claude.ai/code
```

## 扩展阅读

- [项目开发计划](./plans/2025-01-18-ai-native-ppt-copilot-mvp.md)
- [React 官方文档](https://react.dev/)
- [Fabric.js 文档](http://fabricjs.com/)
- [Zustand 文档](https://zustand-demo.pmnd.rs/)
- [Express 文档](https://expressjs.com/)

## 技术支持

如有问题，请通过以下方式获取帮助:
- GitHub Issues: https://github.com/allanpk716/make-ppt-great-again/issues
- 查看项目文档: `docs/` 目录
- 查看代码注释: 源文件中的详细注释
